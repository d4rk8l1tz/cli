#!/bin/bash
#MISE description="Run all benchmarks"

set -euo pipefail

output=$(go test -bench=. -benchmem -run='^$' -timeout=10m ./... 2>&1)

# Print non-benchmark lines (ok, PASS, etc.) to stderr
echo "$output" | grep -v '^Benchmark' >&2

# Format benchmark lines as a table with headers using column
bench_lines=$(echo "$output" | grep '^Benchmark' || true)
if [ -n "$bench_lines" ]; then
  {
    echo "BENCHMARK ITERS MS/OP NS/OP B/OP ALLOCS/OP"
    echo "--------- ----- ----- ----- ---- ---------"
    # Strip unit suffixes and add ms/op column (ns/op / 1000000)
    echo "$bench_lines" | sed 's/ ns\/op//g; s/ B\/op//g; s/ allocs\/op//g; s/ transcript_bytes//g' \
      | awk '{printf "%s %s %.2f %s %s %s\n", $1, $2, $3/1000000, $3, $4, $5}'
  } | column -t
fi
