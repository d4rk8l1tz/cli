[tools]
# Please also keep the version aligned in the go.mod file
go = { version = '1.26.0', postinstall = "go install github.com/go-delve/delve/cmd/dlv@latest && go install gotest.tools/gotestsum@latest" }
golangci-lint = '2.10.1'
shellcheck = 'latest'
tmux = 'latest'

[tasks.fmt]
description = "Run gofmt"
run = "gofmt -s -w ."

[tasks.test]
description = "Run tests"
run = "go test ./..."

[tasks."test:integration"]
description = "Run integration tests"
run = "go test -tags=integration ./cmd/entire/cli/integration_test/..."

[tasks."test:ci"]
description = "Run all tests (unit + integration) with race detection"
run = "go test -tags=integration -race ./..."

[tasks.build]
description = "Build the CLI"
run = """
VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
go build -ldflags "-X github.com/entireio/cli/cmd/entire/cli/versioninfo.Version=${VERSION} -X github.com/entireio/cli/cmd/entire/cli/versioninfo.Commit=${COMMIT}" -o entire ./cmd/entire
"""

[tasks."build:all"]
description = "Build for all platforms using goreleaser"
run = "goreleaser build --snapshot --clean"

[tasks."completions"]
description = "generate entire shell completions"
quiet = true
run = """
rm -rf completions
mkdir completions
for sh in bash zsh fish; do
    go run ./cmd/entire/main.go completion "$sh" >"completions/entire.$sh"
done
"""

[tasks.dup]
description = "Check for code duplication (threshold 50, with summary)"
run = """
#!/usr/bin/env bash
set -euo pipefail

# Create temp files with proper extensions (works on both Linux and macOS)
tmpdir=$(mktemp -d)
config="$tmpdir/config.yaml"
json_out="$tmpdir/output.json"

cat > "$config" << 'YAML'
version: "2"
linters:
  default: none
  enable: [dupl]
  settings:
    dupl:
      threshold: 50
YAML

# Run with JSON output for summary, text output for details
golangci-lint run -c "$config" --new=false --max-issues-per-linter=0 --max-same-issues=0 \
  --output.json.path="$json_out" --output.text.path=/dev/stderr ./... 2>&1 || true

# Print summary grouped by file
echo ""
echo "=== Duplication Summary (by file) ==="
if command -v jq &>/dev/null && [ -s "$json_out" ]; then
  jq -r '.Issues // [] | group_by(.Pos.Filename) | map({file: (.[0].Pos.Filename | split("/") | .[-1]), count: length}) | sort_by(-.count) | .[] | "  " + (.count|tostring) + " " + .file' "$json_out" 2>/dev/null || echo "  (no issues)"
else
  echo "  (install jq for summary)"
fi

rm -rf "$tmpdir"
"""

[tasks."dup:staged"]
description = "Check duplication in staged files only (threshold 75, same as CI)"
run = """
#!/usr/bin/env bash
set -euo pipefail

# Get staged Go files, preserving paths with spaces using null delimiters throughout
if ! git diff --cached --name-only -z --diff-filter=ACM | grep -z '\\.go$' | grep -zq .; then
  echo "No staged Go files to check"
  exit 0
fi
echo "Checking staged files for duplication..."
git diff --cached --name-only -z --diff-filter=ACM | grep -z '\\.go$' | xargs -0 golangci-lint run --enable-only dupl --new=false --max-issues-per-linter=0 --max-same-issues=0
"""

[tasks.bench]
description = "Run all benchmarks"
run = '''
#!/usr/bin/env bash
set -euo pipefail

output=$(go test -bench=. -benchmem -run='^$' -timeout=10m ./... 2>&1)

# Print non-benchmark lines (ok, PASS, etc.) to stderr
echo "$output" | grep -v '^Benchmark' >&2

# Format benchmark lines as a table with headers using column
bench_lines=$(echo "$output" | grep '^Benchmark' || true)
if [ -n "$bench_lines" ]; then
  {
    echo "BENCHMARK ITERS MS/OP NS/OP B/OP ALLOCS/OP"
    echo "--------- ----- ----- ----- ---- ---------"
    # Strip unit suffixes and add ms/op column (ns/op / 1000000)
    echo "$bench_lines" | sed 's/ ns\/op//g; s/ B\/op//g; s/ allocs\/op//g; s/ transcript_bytes//g' \
      | awk '{printf "%s %s %.2f %s %s %s\n", $1, $2, $3/1000000, $3, $4, $5}'
  } | column -t
fi
'''

# E2E test tasks â€” all delegate to mise-tasks/test-e2e.
# To add a new agent: add a task that sets E2E_AGENT and depends on test-e2e.

[tasks."test:e2e"]
description = "Run all E2E tests, optionally filtered: mise run test:e2e TestFoo"
usage = 'arg "[filter]" help="Test name filter (regex)" default=""'
quiet = true
run = "mise run test-e2e ${usage_filter:+\"$usage_filter\"}"

[tasks."test:e2e:claude"]
description = "Run E2E tests with Claude Code only"
usage = 'arg "[filter]" help="Test name filter (regex)" default=""'
quiet = true
run = "E2E_AGENT=claude-code mise run test-e2e ${usage_filter:+\"$usage_filter\"}"

[tasks."test:e2e:gemini"]
description = "Run E2E tests with Gemini CLI only"
usage = 'arg "[filter]" help="Test name filter (regex)" default=""'
quiet = true
run = "E2E_AGENT=gemini-cli mise run test-e2e ${usage_filter:+\"$usage_filter\"}"

[tasks."test:e2e:opencode"]
description = "Run E2E tests with OpenCode only"
usage = 'arg "[filter]" help="Test name filter (regex)" default=""'
quiet = true
run = "E2E_AGENT=opencode mise run test-e2e ${usage_filter:+\"$usage_filter\"}"
